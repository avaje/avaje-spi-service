name: Close Milestone on Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      milestone_tag:
        description: 'Specify Release Tag (e.g., v1.2.3). Leave empty for LATEST.'
        required: false
        default: ''

jobs:
  close_milestone:
    runs-on: ubuntu-latest
    # Grant permissions to write to issues/milestones
    permissions:
      issues: write
      contents: read

    steps:
      - name: Determine Target Release Tag
        id: determine_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          elif [[ -n "${{ github.event.inputs.milestone_tag }}" ]]; then
            RELEASE_TAG="${{ github.event.inputs.milestone_tag }}"
          else
            # Fetch the latest published release tag via CLI
            RELEASE_TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name')
          fi

          # Strip 'v' prefix for milestone matching
          MILESTONE_TITLE="${RELEASE_TAG#v}"
          echo "MILESTONE_TITLE=$MILESTONE_TITLE" >> $GITHUB_OUTPUT
          echo "Targeting Milestone: $MILESTONE_TITLE"

      - name: Close Corresponding Milestone
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TITLE: ${{ steps.determine_tag.outputs.MILESTONE_TITLE }}
        run: |

          # 1. Get Milestone Number by Title
          MILESTONE_NUMBER=$(gh api repos/${{ github.repository }}/milestones \
            -f state='open' \
            --jq ".[] | select(.title==\"$TITLE\") | .number")

          # 2. Close if found
          if [ -z "$MILESTONE_NUMBER" ]; then
            echo "No open milestone found with title '$TITLE'. Skipping."
          else
            echo "Closing milestone #$MILESTONE_NUMBER..."
            gh api --method PATCH repos/${{ github.repository }}/milestones/$MILESTONE_NUMBER \
              -f state='closed'
            echo "Successfully closed milestone '$TITLE'."
          fi
